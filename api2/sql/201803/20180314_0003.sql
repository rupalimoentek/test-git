-- Remove existing table npanxx_city_small
Delete TABLE npanxx_city_small;

-- Create table with updated query npanxx_city_small
CREATE TABLE npanxx_city_small as select max(zipcode) as zipcode,npanxx,state,max(city) as city,country FROM npanxx_city GROUP BY npanxx,state,country;

-- Add index for table npanxx_city_small
CREATE INDEX npanxx_idx ON npanxx_city_small (npanxx);

-- Add permissions for looker user
GRANT ALL ON table public.npanxx_city_small to looker;


-- Add new columns to ct_user_detail table  agent_code, agent_ring_to
ALTER TABLE ct_user_detail ADD COLUMN agent_code integer, ADD COLUMN agent_ring_to character varying(45);

### Add new template into email master to send unauthorised access notification to user for email recording.

INSERT INTO public.email_master
(email_code, email_name, email_desc, email_active, dynamic_field, field_display, html_template, email_created, email_modified, email_subject)
VALUES('unauthorized', 'Unauthorized attempt to access recording file', 'Unauthorized attempt to access recording file', true, NULL, NULL, '<!doctype html><html xmlns=http://www.w3.org/1999/xhtml><head><meta http-equiv=Content-Type content="text/html; charset=UTF-8"/><title>Email</title><style type=text/css>.ReadMsgBody{width:100%;background-color:#fff}.ExternalClass{width:100%;background-color:#fff}body{width:100%;background-color:#fff;margin:0;padding:0;-webkit-font-smoothing:antialiased;font-family:Georgia,Times,serif}table{border-collapse:collapse}@media only screen and (max-width:640px){body[yahoo] .deviceWidth{width:440px!important;padding:0}body[yahoo] .center{text-align:center!important}}@media only screen and (max-width:479px){body[yahoo] .deviceWidth{width:280px!important;padding:0}body[yahoo] .center{text-align:center!important}}</style></head><body leftmargin=0 topmargin=0 marginwidth=0 marginheight=0 yahoo=fix style=font-family:Georgia,Times,serif><table width=100% border=0 cellpadding=0 cellspacing=0 align=center><tr><td width=100% valign=top bgcolor=#ffffff style=padding-top:20px><table width=580 border=0 cellpadding=0 cellspacing=0 align=center class=deviceWidth style="margin:0 auto"><tr><td width=100% bgcolor=#ffffff><table border=0 cellpadding=0 cellspacing=0 align=center class=deviceWidth><tr><td style="padding:10px 20px 20px" class=center> <img src=https://www.convirza.com/wp-content/themes/fluid-yeti/assets/img/header-logo.png alt border=0/> </td></tr></table></td></tr></table><table width=580 class=deviceWidth border=0 cellpadding=0 cellspacing=0 align=center bgcolor=#eeeeed style="margin:0 auto"><tr><td style="font-size:13px;color:#959598;font-weight:normal;text-align:left;font-family:Georgia,Times,serif;line-height:24px;vertical-align:top;padding:10px 8px 10px 8px" bgcolor=#fff><table><tr><td valign=middle style="padding:0 10px 10px 0"><span style=text-decoration:none;color:#272727;font-size:18px;color:#272727;font-weight:bold;font-family:Arial,sans-serif>Unauthorised attempt</span> </td></tr></table>The user that sent this email does not have necessary permissions to access the requested audio file. Please notify the sender that the audio file was not successfully received.</td></tr></table><table width=580 border=0 cellpadding=0 cellspacing=0 align=center class=deviceWidth style="margin:0 auto"><tr><td style="padding:10px 0"><table align=right width=99% cellpadding=0 cellspacing=0 border=0 class=deviceWidth><tr><td style=font-size:12px;font-weight:normal;text-align:left;font-family:Arial,sans-serif;line-height:24px;vertical-align:top;padding:10px></td></tr></table></td></tr><tr><td><div style=height:6px>&nbsp;</div></td></tr></table><div style="height:15px;margin:0 auto">&nbsp;</div><table width=580 cellpadding=0 cellspacing=0 align=center class=deviceWidth bgcolor=#202022 style="margin:0 auto"> </table><div style="height:15px;margin:0 auto">&nbsp;</div><table width=100% border=0 cellpadding=0 cellspacing=0 align=center style=background-color:#363636><tr><td style="padding:30px 0"><table width=580 border=0 cellpadding=10 cellspacing=0 align=center class=deviceWidth style="margin:0 auto"><tr><td><table width=45% cellpadding=0 cellspacing=0 border=0 align=left class=deviceWidth><tr><td valign=top style=font-size:11px;color:#efefef;color:#ccc;font-family:Arial,sans-serif;padding-bottom:20px class=center> <span style=color:#efefef>You are receiving this email because<br/> 1.) You''re an awesome customer and<br/> 2.) You''re setup to receive these emails<br/> <br/> Want to be removed? No problem, contact your company admin or customer service.</span> </td></tr></table><table width=40% cellpadding=0 cellspacing=0 border=0 align=right class=deviceWidth><tr><td valign=top style=font-size:11px;color:#f1f1f1;font-weight:normal;font-family:Arial,sans-serif;line-height:26px;vertical-align:top;text-align:right class=center> <a href=# style=text-decoration:none;color:#fff;font-weight:bold;font-family:Arial,sans-serif;padding-top:5px>Convirza</a><br/> <a href=# style=text-decoration:none;color:#848484;font-weight:normal>855-889-3939</a><br/> <a href=# style=text-decoration:none;color:#848484;font-weight:normal>support@convirza.com</a> </td></tr></table></td></tr></table></td></tr></table></td></tr></table><div style="display:none;white-space:nowrap;font:15px courier;color:#fff"> - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - </div></body></html>', '2015-11-18', NULL, 'unauthorized');

-- Update user name for user creation.
UPDATE public.ct_user SET first_name='User', last_name='Creation', username='usercreation@messages.services' WHERE username='convirza.dev@gmail.com';

###############################################################################

## Staging 

-- insert reports data into reports table 
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1111 , 'Call Logs' , 'Contains information regarding Call Logs/Call Back' , 50 , TRUE , FALSE , '{}' , 51 , FALSE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1112 , 'Call Flow Settings' , 'Call Flow Settings Report' , 85 , TRUE , FALSE , '{}' , 85 , TRUE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1114 , 'User Logs' , 'User Logs' , 93 , TRUE , FALSE , '{}' , 93 , TRUE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1120 , 'Tags Summary' , 'Tags Summary Report' , 45 , TRUE , FALSE , '{}' , 45 , TRUE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1127 , 'Call Trends' , 'Call Trends Report' , 38 , TRUE , FALSE , '{}' , 38 , FALSE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1128 , 'Analytics Summary' , 'Analytics Summary' , 53 , TRUE , FALSE , '{}' , 53 , FALSE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1129 , 'Webhook Logs' , 'Webhook Log Report' , 64 , TRUE , FALSE , '{}' , 64 , TRUE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1130 , 'Calls by Region' , 'Calls by Region Report' , 40 , TRUE , FALSE , '{}' , 40 , FALSE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1131 , 'Caller Activity' , 'Caller Activity Report' , 49 , TRUE , FALSE , '{}' , 49 , FALSE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1133 , 'Account Details' , 'Account Details Report' , 95 , TRUE , FALSE , '{}' , 95 , TRUE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1134 , 'Billing Usage' , 'Billing Usage Report' , 96 , TRUE , FALSE , '{}' , 99 , TRUE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1136 , 'Marketing Dashboard' , 'Marketing Dashboard' , 58 , TRUE , FALSE , '{}' , 63 , FALSE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1137 , 'Call Overview' , 'Call Overview Report for Gravitate Online' , 10 , FALSE , FALSE , '{8,7414,194}' , 10 , FALSE );

##################################################################################

## Production
-- insert reports data into reports table for prod looker dashboars ids.
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1111 , 'Call Logs' , 'Contains information regarding Call Logs/Call Back' , 63 , TRUE , FALSE , '{}' , 64 , FALSE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1112 , 'Call Flow Settings' , 'Call Flow Settings Report' , 61 , TRUE , FALSE , '{}' , 61 , TRUE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1114 , 'User Logs' , 'User Logs' , 76 , TRUE , FALSE , '{}' , 76 , TRUE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1120 , 'Tags Summary' , 'Tags Summary Report' , 75 , TRUE , FALSE , '{}' , 75 , TRUE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1127 , 'Call Trends' , 'Call Trends Report' , 67 , TRUE , FALSE , '{}' , 67 , FALSE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1128 , 'Analytics Summary' , 'Analytics Summary' , 57 , TRUE , FALSE , '{}' , 57 , FALSE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1129 , 'Webhook Logs' , 'Webhook Log Report' , 77 , TRUE , FALSE , '{}' , 77 , TRUE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1130 , 'Calls by Region' , 'Calls by Region Report' , 60 , TRUE , FALSE , '{}' , 60 , FALSE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1131 , 'Caller Activity' , 'Caller Activity Report' , 68 , TRUE , FALSE , '{}' , 68 , FALSE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1133 , 'Account Details' , 'Account Details Report' , 56 , TRUE , FALSE , '{}' , 56 , TRUE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1134 , 'Billing Usage' , 'Billing Usage Report' , 58 , TRUE , FALSE , '{}' , 59 , TRUE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1136 , 'Marketing Dashboard' , 'Marketing Dashboard' , 69 , TRUE , FALSE , '{}' , 70 , FALSE );
INSERT INTO public.reports(report_id, report_name, report_description, looker_id, is_default,is_deleted, report_ous, ca_looker_id, is_admin_only) VALUES ( 1137 , 'Call Overview' , 'Call Overview Report for Gravitate Online' , 10 , FALSE , FALSE , '{8,7414,194}' , 10 , FALSE );